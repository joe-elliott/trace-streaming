<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Go WebSocket Tutorial</title>
  </head>
  <body>
    <h2>Let's goooo!</h2>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
       const maxTraces = 50
       let traces = []

        let socket = new WebSocket("ws://127.0.0.1:31235/socket");
        console.log("Attempting Connection...");

        socket.onopen = () => {
            console.log("Successfully Connected");
            socket.send("Hi From the Client!")
        };
        
        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
            socket.send("Client Closed!")
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        socket.onmessage = msg => {
            console.log("Message: ", msg)

            if (msg.data != "{}") {
              traces.push(JSON.parse(msg.data).spans)
              if (traces.length > maxTraces) traces.pop()
              
              makeTree(traces)
            }
        }
    </script>
    <script>
      function makeTree(traces) {
        allSpans = traces.flat()

        rootSpan = {
          spanID : "root",
          processName : "root",
          operationName : "root",
          parentSpanID : "",
          duration: 0,
        }
        allSpans.push(rootSpan)
        
        var data = d3.stratify()
                      .id(function(d) { return d.spanID })
                      .parentId(function(d) { return "parentSpanID" in d ? d.parentSpanID : "root" })
                      (allSpans)

        width = 932
        var root = d3.hierarchy(data)
                    .sum(d => 1)
                    .sort((a, b) => 0)
        
        root.dx = 10
        root.dy = width / (root.height + 1)

        var treeLayout = d3.tree().nodeSize([root.dx, root.dy])(root);

        let x0 = 0;
        let x1 = -x0;
        root.each(d => {
          if (d.x > x1) x1 = d.x;
          if (d.x < x0) x0 = d.x;
        });

        d3.select("body svg").remove();
        var svg = d3.select("body").append("svg").attr("viewBox", [0, 0, width, x1 - x0 + root.dx * 2]);       

        const g = svg.append("g")
            .attr("font-family", "sans-serif")
            .attr("font-size", 10)
            .attr("transform", `translate(${root.dy / 3},${root.dx - x0})`);
          
        const link = g.append("g")
          .attr("fill", "none")
          .attr("stroke", "#555")
          .attr("stroke-opacity", 0.4)
          .attr("stroke-width", 1.5)
        .selectAll("path")
          .data(root.links())
          .join("path")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x));
        
        const node = g.append("g")
            .attr("stroke-linejoin", "round")
            .attr("stroke-width", 3)
          .selectAll("g")
          .data(root.descendants())
          .join("g")
            .attr("transform", d => `translate(${d.y},${d.x})`);

        node.append("circle")
            .attr("fill", d => d.children ? "#555" : "#999")
            .attr("r", 2.5);

        node.append("text")
            .attr("dy", "0.31em")
            .attr("x", d => d.children ? -6 : 6)
            .attr("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.data.processName + "-" + d.data.data.operationName )
          .clone(true).lower()
            .attr("stroke", "white");
      }
    </script>
  </body>
</html>