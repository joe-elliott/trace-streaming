<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Trace Stream Example</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="flamegraph.css">
    <style>
        /* Space out content a bit */
        body {
          padding-top: 20px;
          padding-bottom: 20px;
        }
        /* Custom page header */
        .header {
          padding-bottom: 20px;
          padding-right: 15px;
          padding-left: 15px;
          border-bottom: 1px solid #e5e5e5;
        }
        /* Make the masthead heading the same height as the navigation */
        .header h3 {
          margin-top: 0;
          margin-bottom: 0;
          line-height: 40px;
        }
        /* Customize container */
        .container {
          max-width: 990px;
        }
    </style>
  </head>
  <body>
      <div class="container">
          <div class="header clearfix">
            <nav>
              <div class="pull-right">
                <form class="form-inline" id="form">
                  <a class="btn" href="javascript: resetZoom();">Reset zoom</a>
                  <a class="btn" href="javascript: clear();">Clear</a>
                  <div class="form-group">
                    <input type="text" class="form-control" id="term">
                  </div>
                  <a class="btn btn-primary" href="javascript: search();">Search</a>
                </form>
              </div>
            </nav>
            <h3 class="text-muted">trace streaming</h3>
          </div>
          <div id="chart">
          </div>
          <hr>
          <div id="details">
          </div>
          <hr>
          <div id="table">
              <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">trace id</th>
                      <th scope="col">process name</th>
                      <th scope="col">span name</th>
                      <th scope="col">duration</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
          </div>
        </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script type="text/javascript" src=https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js></script>
    <script type="text/javascript" src="flamegraph.js"></script>
    <script>
       const maxTraces = 50
       let traces = []
       const maxSpans = 20
       let spans = []

        let socket = new WebSocket("ws://127.0.0.1:31235/v1/stream/traces");
        console.log("Attempting Connection...");

        socket.onopen = () => {
            console.log("Successfully Connected");
        };
        
        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        socket.onmessage = msg => {
            console.log("Message: ", msg)

            if (msg.data != "{}") {
              traces.push(JSON.parse(msg.data).spans)
              if (traces.length > maxTraces) traces.pop()
              
              makeTree(traces)
            }
        }

        let spanSocket = new WebSocket("ws://127.0.0.1:31235/v1/stream/spans?processName=route");
        spanSocket.onopen = () => {
            console.log("Successfully Connected Spans");
        };
        
        spanSocket.onclose = event => {
            console.log("Socket Closed Span Connection: ", event);
        };

        spanSocket.onerror = error => {
            console.log("Span Socket Error: ", error);
        };

        spanSocket.onmessage = msg => {
            console.log("Message: ", msg)

            if (msg.data != "{}") {
              spans.push(...JSON.parse(msg.data).spans)
              while (spans.length > maxTraces) spans.pop()
              
              displaySpans(spans)
            }
        }
    </script>
    <script>
      var flamegraph

      function makeTree(traces) {
        allSpans = traces.flat()

        rootSpan = {
          spanID : "root",
          processName : "root",
          operationName : "root",
          parentSpanID : "",
          duration: 0,
        }
        allSpans.push(rootSpan)
        
        var data = d3.stratify()
                      .id(function(d) { return d.spanID })
                      .parentId(function(d) { return "parentSpanID" in d ? d.parentSpanID : "root" })
                      (allSpans)

        collapse(data)

        var root = d3.hierarchy(data)
             .sum(d => d.value)
        root.each(d => d.name = d.data.data.processName + "-" + d.data.data.operationName)

        if (flamegraph) {
          flamegraph.update(root)
          return
        }

        var color = d3.scaleOrdinal(d3.schemePaired)
        flamegraph = d3.flamegraph()
                           .width(960)
                           .height(300)
                           .cellHeight(18)
                           .transitionDuration(750)
                           .minFrameSize(5)
                           .sort(true)
                           .title("")
                           .onClick(onClick)
                           .differential(false)
                           .selfValue(false)

        flamegraph.setColorMapper(function(d, originalColor) {
          return d.highlight ? "#E600E6" : color(d.data.data.data.processName);
        });

        flamegraph.label(d => d.data.name);

        var tip = d3.tip()
        .direction("s")
        .offset([8, 0])
        .attr('class', 'd3-flame-graph-tip')
        .html(function(d) { return d.data.data.name });

        var details = document.getElementById("details");
          flamegraph.setDetailsElement(details);

        d3.select("#chart")
            .datum(root)
            .call(flamegraph);

        document.getElementById("form").addEventListener("submit", function(event){
          event.preventDefault();
          search();
        });
      }

      function collapse(node) {
        if(!("children" in node)) {
          return
        }

        agg = new Map()

        node.children.forEach( c => {
            name = c.data.processName + "-" + c.data.operationName

            if (agg.has(name)) {
              merge(agg.get(name), c)
            } else {
              c.value = 1
              agg.set(name, c)
            }
        })

        node.children = Array.from(agg.values())
        node.value -= node.children.length

        node.children.forEach(c => collapse(c))
      }

      function merge(n1, n2) {
        all = []
        if (n1.children) n1.children.forEach(c => {all.push(c)})
        if (n2.children) n2.children.forEach(c => {all.push(c)})
        all.forEach(c => c.parent = n1)
        n1.children = all

        n1.value++
      }

      function onClick(d) {
        console.info("Clicked on " + d.data.name);
      }

      function search() {
          var term = document.getElementById("term").value;
          flamegraph.search(term);
        }
        function clear() {
          document.getElementById('term').value = '';
          flamegraph.clear();
        }
        function resetZoom() {
          flamegraph.resetZoom();
        }
    </script>
    <script>
      function displaySpans(spans) {
        table = d3.select("#table table tbody")
        table.text("")

        spans.forEach(s => {
          row = table.append("tr")

          row.append("td").text(s.traceID)
          row.append("td").text(s.processName)
          row.append("td").text(s.operationName)
          row.append("td").text(s.duration)
        })
      }
    </script>
  </body>
</html>